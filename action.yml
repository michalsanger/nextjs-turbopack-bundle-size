name: 'Next.js Turbopack Bundle Size'
description: 'Tracks bundle size changes across PRs for Next.js apps built with Turbopack'
author: 'michalsanger'

branding:
  icon: 'package'
  color: 'blue'

inputs:
  github-token:
    description: 'GitHub token for downloading baseline artifact and posting PR comments'
    required: true
  stats-path:
    description: 'Path to the Turbopack webpack-stats.json generated by the build'
    required: false
    default: '.next/server/webpack-stats.json'
  artifact-name:
    description: 'Artifact name used to store and retrieve the baseline stats from the main branch'
    required: false
    default: 'turbopack-main-stats'
  minimum-change-threshold:
    description: 'Byte threshold below which a size change is considered unchanged'
    required: false
    default: '0'
  budget-percent-increase-red:
    description: 'Percentage threshold for showing ðŸ”´ on size increases. Increases above this percentage show ðŸ”´, others show ðŸŸ¡. Default 0 means all increases show ðŸ”´.'
    required: false
    default: '0'

runs:
  using: composite
  steps:
    - name: Compute baseline route sizes
      if: github.ref == 'refs/heads/main'
      uses: actions/github-script@v8.0.0
      env:
        STATS_PATH: ${{ inputs.stats-path }}
        ACTION_PATH: ${{ github.action_path }}
      with:
        script: |
          const path = require('path');
          const { saveRouteSizes } = require(
            path.join(process.env.ACTION_PATH, 'src', 'parse-stats.js')
          );
          saveRouteSizes(process.env.STATS_PATH, 'bundle-route-sizes.json');

    - name: Upload baseline stats
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v6.0.0
      with:
        name: ${{ inputs.artifact-name }}
        path: |
          ${{ inputs.stats-path }}
          bundle-route-sizes.json
        overwrite: true

    - name: Download baseline stats
      if: github.event_name == 'pull_request'
      uses: dawidd6/action-download-artifact@v15
      continue-on-error: true
      with:
        github_token: ${{ inputs.github-token }}
        branch: main
        name: ${{ inputs.artifact-name }}
        path: _bundle-baseline-stats

    - name: Calculate bundle sizes and diff
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v8.0.0
      env:
        STATS_PATH: ${{ inputs.stats-path }}
        ACTION_PATH: ${{ github.action_path }}
        MINIMUM_CHANGE_THRESHOLD: ${{ inputs.minimum-change-threshold }}
        BUDGET_PERCENT_INCREASE_RED: ${{ inputs.budget-percent-increase-red }}
      with:
        script: |
          const path = require('path');
          const fs = require('fs');
          const { parseStatsFile, loadRouteSizes, generateReport } = require(
            path.join(process.env.ACTION_PATH, 'src', 'parse-stats.js')
          );

          const threshold = parseInt(process.env.MINIMUM_CHANGE_THRESHOLD) || 0;
          const budgetPercentIncreaseRed = parseInt(process.env.BUDGET_PERCENT_INCREASE_RED) || 0;
          const currentRoutes = parseStatsFile(process.env.STATS_PATH, true);

          const precomputedPath = path.join('_bundle-baseline-stats', 'bundle-route-sizes.json');
          const fallbackPath = path.join('_bundle-baseline-stats', 'webpack-stats.json');
          const baselineRoutes = fs.existsSync(precomputedPath)
            ? loadRouteSizes(precomputedPath)
            : parseStatsFile(fallbackPath, false);

          fs.writeFileSync('bundle-report.md', generateReport(currentRoutes, baselineRoutes, threshold, budgetPercentIncreaseRed));

    - name: Post or update PR comment
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2.9.4
      with:
        header: bundle-size-report
        path: bundle-report.md
