name: 'Next.js Turbopack Bundle Size'
description: 'Tracks bundle size changes across PRs for Next.js apps built with Turbopack'
author: 'michalsanger'

branding:
  icon: 'package'
  color: 'blue'

inputs:
  github-token:
    description: 'GitHub token for downloading baseline artifact and posting PR comments'
    required: true
  stats-path:
    description: 'Path to the Turbopack webpack-stats.json generated by the build'
    required: false
    default: '.next/server/webpack-stats.json'
  artifact-name:
    description: 'Artifact name used to store and retrieve the baseline stats from the main branch'
    required: false
    default: 'turbopack-main-stats'

runs:
  using: composite
  steps:
    - name: Upload baseline stats
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v6.0.0
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.stats-path }}
        overwrite: true

    - name: Download baseline stats
      if: github.event_name == 'pull_request'
      uses: dawidd6/action-download-artifact@v15
      continue-on-error: true
      with:
        github_token: ${{ inputs.github-token }}
        branch: main
        name: ${{ inputs.artifact-name }}
        path: _bundle-baseline-stats

    - name: Calculate bundle sizes and diff
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v8.0.0
      env:
        STATS_PATH: ${{ inputs.stats-path }}
        ACTION_PATH: ${{ github.action_path }}
      with:
        script: |
          const path = require('path');
          const fs = require('fs');
          const { parseStatsFile, generateReport, loadConfig } = require(
            path.join(process.env.ACTION_PATH, 'src', 'parse-stats.js')
          );

          const config = loadConfig('package.json');
          const currentRoutes = parseStatsFile(process.env.STATS_PATH, true);
          const baselineRoutes = parseStatsFile(
            path.join('_bundle-baseline-stats', 'webpack-stats.json'),
            false,
          );

          fs.writeFileSync('bundle-report.md', generateReport(currentRoutes, baselineRoutes, config));

    - name: Post or update PR comment
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2.9.4
      with:
        header: bundle-size-report
        path: bundle-report.md
